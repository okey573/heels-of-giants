---
title: 事件机制
---

## 写在前面

_js的运行机制在node环境和在浏览器环境是不同的_

## 事件执行顺序

1. 任务分为同步任务和异步任务，异步任务分为宏任务和微任务（并不是所有的宏任务都是异步任务，例如整个script块就是宏任务）
2. 执行同步任务，异步任务进入event table，进入到event table的任务到了指定时间会进入event queue（比如ajax返回，setTimeout的延迟结束）
3. event queue分为宏任务的队列和微任务的队列，从event table进入到event queue时，会根据任务类型进入到不同的队列
4. 执行宏任务
5. 执行所有队列中的微任务
6. js线程挂起，gui接管 dom渲染更新
7. vue的nextTick就是在此时执行

## 宏任务和微任务的区分

- 宏任务：当前调用栈中执行的代码成为宏任务。（主代码快，宿主发起的任务也就是node或者浏览器发起的任务，定时器等等）。
- 微任务： 当前（此次事件循环中）宏任务执行完，在下一个宏任务开始之前需要执行的任务,可以理解为回调事件。（promise.then，proness.nextTick等等）。
- 宏任务中的事件放在callback queue中，由事件触发线程维护；微任务的事件放在微任务队列中，由js引擎线程维护

## 验证

```js
console.log('1')

// setTimeout是宏任务
setTimeout(function () {
  console.log('2')
  process.nextTick(function () {
    console.log('3')
  })
  new Promise(function (resolve) {
    console.log('4')
    resolve()
  }).then(function () {
    console.log('5')
  })
})

// nextTick是微任务
process.nextTick(function () {
  console.log('6')
})

// promise是微任务
new Promise(function (resolve) {
  console.log('7')
  resolve()
}).then(function () {
  console.log('8')
})

// setTimeout是宏任务
setTimeout(function () {
  console.log('9')
  process.nextTick(function () {
    console.log('10')
  })
  new Promise(function (resolve) {
    console.log('11')
    resolve()
  }).then(function () {
    console.log('12')
  })
})


/**
 * 1
 * 7
 * 6
 * 8
 * 2
 * 4
 * 3
 * 5
 * 9
 * 11
 * 10
 * 12
 */

```
