---
title: url 到页面显示
---

# 在浏览器地址栏输入 URL 到页面显示

## 概览

![流程](/images/url-to-display.png)


## 1. 浏览器预处理

1. 浏览器判断输入的内容是否符合 URL 规则，否则当做搜索内容处理。
    1. 搜索内容：浏览器默认搜索引擎 + 搜索内容拼接成新 URL
    2. URL：将 URL + 协议，合成新的合法 URL
2. 此时按下回车，浏览器导航栏开始显示 loading 但还是之前的页面，这是因为此时还没获得新页面的数据

## 2. 浏览器解析 URL 获得 IP 地址

1. 浏览器主进程构建请求信息，通过进程通信（IPC）将 URL 请求发送给网络进程
2. 网络进程获取到 URL 先判断是是否存在缓存
    1. 存在缓存：拦截 URL 请求，返回缓存内容，code 码为 200
    2. 不存在缓存：进入到网络请求
3. 系统首先判断本地 host 文件是否存在对应域名
    1. 存在：取得对应 IP 地址
    2. 不存在：提交 DNS 域名解析服务器进行 IP 地址的解析

- DNS 解析是一个递归的过程

- DNS 缓存优化: 浏览器缓存，系统缓存，路由器缓存，IPS服务器缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存

- DNS 负载均衡: DNS 可以返回一个合适的机器的 IP 给用户，例如可以根据每台机器的负载量，该机器离用户地理位置的距离等等，这种过程就是 DNS 负载均衡，又叫做 DNS 重定向。CDN (Content Delivery Network) 就是利用 DNS 的重定向技术

## 3. 通过 TCP 协议三次握手建立连接

1. Chrome 有个机制，同一个域名同时最多只能建立 6 个TCP 连接，如果在同一个域名下同时有 10 个请求发生，那么其中 4 个请求会进入排队等待状态，直至进行中的请求完成。如果当前请求数量少于6个，会直接建立 TCP 连接
2. TCP 三次握手建立连接，HTTP 请求加上 TCP 头部——包括源端口号、目的程序端口号和用于校验数据完整性的序号，向下传输

## 4. 数据传输

1. 数据传输到网络层（建立 TCP 连接实际上就在传输层了），网络层在数据包上加上 IP 头部——包括源 IP 地址和目的 IP 地址，继续向下传输到底层
2. 数据包再经过数据链路层，物理层传输
3. 在传输途中按层级依次解开数据头部，最终将数据传输给服务器应用层

## 5. 服务器处理数据

1. 服务器通过 HTTP 协议，解析请求头和请求体
2. 判断是否需要重定向
    1. 需要重定向：返回 301 或者 302 ，同时在响应头部的 Location 中附上重定向的目标地址，浏览器会根据 code 和 Location 执行重定向操作
    2. 不需要重定向：通过请求头中的 If-None-Match 和 If-Modified-Since 等信息判断是否命中缓存。如果命中缓存，返回 304 状态码。否则返回最新数据，状态码为 200，另外此时还可以设置 Cache-Control 强缓存头部信息

## 6. 数据传输

1. 响应数据又顺着应用层——传输层——网络层——网络层——传输层——应用层的顺序返回到网络进程
2. 数据传输完成后四次挥手断开连接，如果服务器或者浏览器设置了 keep-alive 则会保持连接

## 7. 浏览器处理数据

1. 网络进程将获取到的数据包进行解析，根据响应头中的Content-type来判断响应数据的类型，如果是字节流类型，就将该请求交给下载管理器，该导航流程结束，不再进行
2. 如果是text/html类型，就通知浏览器进程获取到文档准备渲染

## 8.渲染

1. 浏览器主进程把数据发送到渲染进程，浏览器会判断是否满足公用渲染进程的条件，比如新打开的页面和之前的是同站点，就会复用之前的渲染进程，否则新创建一个渲染进程。
2. 渲染进程接受到数据后，会发送一个“确认提交”的消息给浏览器主进程，浏览器接受到消息后会更新浏览器的状态，比如地址栏的URL，安全状态，前进和后退历史，更新页面（此时是空白）等等
3. 渲染进程解析文档解析和子资源加载，HTML 标签通过 HTML 解析器转换成 DOM Tree， CSS 按照 CSS 规则和 CSS 解释器转换成 CSSOM Tree， 两个 Tree 结合变成 Render Tree
4. 计算每个元素的位置和大小完成渲染
5. 渲染完成后通知浏览器主进程，结束页面标签的 loading 状态

## 一些细节点

- 复用渲染进程（鼠标左键直接打开和右键打开新链接不一样）
- keep-alive
- 缓存

## 参考链接

- [Web 服务器启用 connection - keep-alive 的一些前置条件](https://zhuanlan.zhihu.com/p/573814007)

- [从输入URL到页面加载的全过程](https://www.cnblogs.com/xiaohuochai/p/9193083.html)

- [浏览器渲染页面的流程](https://blog.csdn.net/weixin_43190804/article/details/123092074)

- [浏览器渲染流程（精讲）](https://zhuanlan.zhihu.com/p/586060532)
